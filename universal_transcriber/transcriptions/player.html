<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Transcript Player â€“ pipeline test</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f9f9f9;
        }
        header {
            background: #fff;
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 1.2rem; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 1rem; }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .video-container {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .transcript-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: #fff;
            border-left: 1px solid #ddd;
            position: relative;
        }
        
        .segment {
            margin-bottom: 1.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .segment:hover {
            background: #f0f0f0;
        }
        
        .segment.active {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
        }
        
        .timestamp {
            font-weight: bold;
            color: #1890ff;
            margin-right: 0.5rem;
            font-size: 0.9rem;
        }
        
        .text {
            line-height: 1.6;
        }
        
        mark {
            background-color: #ffe58f;
            padding: 0 2px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .video-container {
                flex: none;
                height: 300px;
            }
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .search-box {
                width: 100%;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>

<header>
    <h1 id="pageTitle">Loading...</h1>
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search transcript...">
    </div>
</header>

<div class="container">
    <div class="video-container">
        <div id="player"></div>
    </div>
    <div class="transcript-container" id="transcript"></div>
</div>

<script>
    // Parse Query Params
    const urlParams = new URLSearchParams(window.location.search);
    const VIDEO_ID = urlParams.get('id');
    const PLATFORM = urlParams.get('platform') || 'youtube';
    const TITLE = urlParams.get('title');

    if (TITLE) {
        document.getElementById('pageTitle').textContent = decodeURIComponent(TITLE);
        document.title = decodeURIComponent(TITLE) + " - Transcript";
    }

    if (!VIDEO_ID) {
        alert("No Video ID provided in URL parameters (?id=...)");
    }

    let SEGMENTS = [];
    let fuse;
    let player;
    let activeSegmentIndex = -1;
    let userScrolled = false;
    let isAutoScrolling = false;

    // Load JSON Data
    const jsonUrl = `${PLATFORM}_${VIDEO_ID}_transcript.json`;
    
    fetch(jsonUrl)
        .then(response => {
            if (!response.ok) throw new Error("Transcript file not found: " + jsonUrl);
            return response.json();
        })
        .then(data => {
            SEGMENTS = data;
            initApp();
        })
        .catch(err => {
            console.error(err);
            document.getElementById('transcript').innerHTML = `<div style="color:red; padding:1rem;">Error loading transcript: ${err.message}</div>`;
        });

    function initApp() {
        // Initialize Fuse
        fuse = new Fuse(SEGMENTS, {
            keys: ['text'],
            includeMatches: true,
            threshold: 0.2,
            ignoreLocation: true,
            minMatchCharLength: 3
        });

        renderSegments(SEGMENTS);
        initYouTubePlayer();
    }

    const transcriptEl = document.getElementById('transcript');
    const searchInput = document.getElementById('searchInput');

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function renderSegments(segmentsToRender) {
        transcriptEl.innerHTML = '';
        
        if (segmentsToRender.length === 0) {
            transcriptEl.innerHTML = '<div style="padding:1rem; color:#666;">No matches found.</div>';
            return;
        }

        segmentsToRender.forEach((seg, index) => {
            let displayText = seg.text;
            let originalIndex = SEGMENTS.indexOf(seg);
            
            if (seg.item) {
                displayText = seg.item.text;
                originalIndex = seg.refIndex;
                
                if (seg.matches && seg.matches.length > 0) {
                    const indices = seg.matches[0].indices;
                    let highlighted = '';
                    let lastIndex = 0;
                    indices.sort((a, b) => a[0] - b[0]);
                    indices.forEach(([start, end]) => {
                        highlighted += displayText.substring(lastIndex, start);
                        highlighted += `<mark>${displayText.substring(start, end + 1)}</mark>`;
                        lastIndex = end + 1;
                    });
                    highlighted += displayText.substring(lastIndex);
                    displayText = highlighted;
                }
                seg = seg.item;
            }

            const div = document.createElement('div');
            div.className = 'segment';
            div.id = `seg-${originalIndex}`;
            div.onclick = () => seekTo(seg.start);
            
            div.innerHTML = `
                <span class="timestamp">${formatTime(seg.start)}</span>
                <span class="text">${displayText}</span>
            `;
            transcriptEl.appendChild(div);
        });
    }

    searchInput.addEventListener('focus', () => {
        if (player && player.pauseVideo) {
            player.pauseVideo();
        }
    });

    searchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        if (!query) {
            renderSegments(SEGMENTS);
            if (activeSegmentIndex !== -1) {
                const el = document.getElementById(`seg-${activeSegmentIndex}`);
                if (el) el.classList.add('active');
            }
            return;
        }
        const results = fuse.search(query);
        renderSegments(results);
    });

    function initYouTubePlayer() {
        if (PLATFORM !== 'youtube') {
            document.getElementById('player').innerHTML = '<div style="color:white; padding:2rem;">Only YouTube player supported currently.</div>';
            return;
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    // Global callback for YouTube API
    window.onYouTubeIframeAPIReady = function() {
        player = new YT.Player('player', {
            height: '100%',
            width: '100%',
            videoId: VIDEO_ID,
            events: {
                'onReady': onPlayerReady
            }
        });
    };

    function onPlayerReady(event) {
        startSyncLoop();
    }

    function seekTo(seconds) {
        if (player && player.seekTo) {
            player.seekTo(seconds, true);
            player.playVideo();
            userScrolled = false;
        }
    }

    transcriptEl.addEventListener('scroll', () => {
        if (!isAutoScrolling) {
             userScrolled = true;
        }
    });

    function startSyncLoop() {
        setInterval(() => {
            if (!player || !player.getCurrentTime) return;
            
            const time = player.getCurrentTime();
            
            let currentIdx = -1;
            for (let i = 0; i < SEGMENTS.length; i++) {
                if (time >= SEGMENTS[i].start && time < SEGMENTS[i].end) {
                    currentIdx = i;
                    break;
                }
                if (time >= SEGMENTS[i].start) {
                    currentIdx = i;
                }
            }
            
            if (currentIdx !== -1 && currentIdx !== activeSegmentIndex) {
                if (activeSegmentIndex !== -1) {
                    const prev = document.getElementById(`seg-${activeSegmentIndex}`);
                    if (prev) prev.classList.remove('active');
                }
                
                const activeEl = document.getElementById(`seg-${currentIdx}`);
                if (activeEl) {
                    activeEl.classList.add('active');
                    
                    if (!userScrolled && !searchInput.value) {
                        isAutoScrolling = true;
                        activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => { isAutoScrolling = false; }, 500);
                    }
                }
                activeSegmentIndex = currentIdx;
            }
            
        }, 200);
    }
</script>
</body>
</html>
