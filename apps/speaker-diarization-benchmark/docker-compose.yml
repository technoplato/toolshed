# =============================================================================
# SPEAKER DIARIZATION BENCHMARK - DOCKER COMPOSE
# =============================================================================
#
# HOW:
#   # Start all services
#   docker compose up -d
#
#   # Start specific service
#   docker compose up -d postgres
#   docker compose up -d instant-proxy
#   docker compose up -d ground-truth-server
#
#   # View logs
#   docker compose logs -f
#   docker compose logs -f instant-proxy
#
#   # Stop all
#   docker compose down
#
#   [Inputs]
#   - Docker Engine running
#   - .env file in project root (toolshed/.env) with:
#     - INSTANT_APP_ID
#     - INSTANT_ADMIN_SECRET
#     - HF_TOKEN (optional, for embedding extraction)
#   - Ports 5433, 3001, and 8000 available
#
#   [Outputs]
#   - PostgreSQL with pgvector on localhost:5433
#   - InstantDB Proxy (TypeScript) on localhost:3001
#   - Ground Truth Server (Python) on localhost:8000
#
#   [Side Effects]
#   - Creates Docker volumes for data persistence
#   - Runs init-db.sql on first Postgres startup
#
# WHO:
#   Claude AI, User
#   (Context: Infrastructure for speaker diarization benchmark)
#
# WHAT:
#   Docker Compose stack providing:
#   1. PostgreSQL + pgvector: Vector database for speaker embeddings
#   2. instant-proxy: TypeScript server wrapping InstantDB Admin SDK
#   3. ground-truth-server: Python server for Ground Truth UI
#
# WHEN:
#   2025-12-07
#   Last Modified: 2025-12-09
#   [Change Log:
#     - 2025-12-09: Renamed instant-server to instant-proxy
#     - 2025-12-09: Added ground-truth-server service
#   ]
#
# WHERE:
#   apps/speaker-diarization-benchmark/docker-compose.yml
#
# WHY:
#   This architecture separates concerns:
#
#   1. PostgreSQL/pgvector handles VECTOR SIMILARITY SEARCH
#      - 512-dimensional speaker embeddings
#      - KNN search for speaker identification
#      - IVFFlat indexing for fast queries
#      - Why not in InstantDB? InstantDB doesn't support vector types
#
#   2. InstantDB handles RELATIONAL DATA + REAL-TIME SYNC
#      - Videos, speakers, segments, assignments
#      - Real-time updates to UI
#      - Schema validation and relationships
#      - Why not just Postgres? We want real-time sync + official SDK
#
#   3. TypeScript proxy wraps InstantDB Admin SDK
#      - InstantDB's Python support is unofficial/unreliable
#      - TypeScript SDK is officially supported + well-documented
#      - Python scripts call TypeScript server via HTTP
#      - Why not direct Python calls? Reduces flaky dependencies
#
#   4. Ground Truth Server provides labeling UI
#      - Serves HTML/JS UI for segment labeling
#      - Handles split/relabel/delete operations
#      - Coordinates InstantDB and PostgreSQL updates
#      - Extracts embeddings when assigning speakers
#
#   ARCHITECTURE:
#   ┌─────────────────┐     HTTP      ┌──────────────────┐     Admin SDK   ┌───────────┐
#   │  Python Scripts │ ◄──────────► │  instant-proxy   │ ◄─────────────► │ InstantDB │
#   │  (audio_ingest) │              │   (TypeScript)   │                 │  (cloud)  │
#   └────────┬────────┘              └──────────────────┘                 └───────────┘
#            │                                ▲
#            │ psycopg                        │ HTTP
#            ▼                                │
#   ┌─────────────────┐              ┌────────┴─────────┐
#   │   PostgreSQL    │              │  ground-truth    │
#   │   (pgvector)    │◄─────────────│     server       │
#   │   localhost:5433│   psycopg    │  localhost:8000  │
#   └─────────────────┘              └──────────────────┘
#                                            │
#                                            ▼
#                                    ┌──────────────────┐
#                                    │   Browser UI     │
#                                    │ (ground_truth_   │
#                                    │  instant.html)   │
#                                    └──────────────────┘
#
# =============================================================================

services:
  # ===========================================================================
  # POSTGRESQL WITH PGVECTOR
  # ===========================================================================
  # Stores 512-dimensional speaker voice embeddings for KNN search.
  # Used by Python scripts directly via psycopg.
  #
  # Why pgvector?
  # - Purpose-built for vector similarity search
  # - IVFFlat index provides O(√n) query time vs O(n) brute force
  # - Native PostgreSQL = familiar tooling, transactions, reliability
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: speaker-diarization-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: diarization
      POSTGRES_PASSWORD: diarization_dev
      POSTGRES_DB: speaker_embeddings
    ports:
      # Use 5433 to avoid conflicts with local postgres on 5432
      - "5433:5432"
    volumes:
      # Persistent data storage
      - pgdata:/var/lib/postgresql/data
      # Init script runs on first startup only
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U diarization -d speaker_embeddings"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # INSTANTDB PROXY (TypeScript)
  # ===========================================================================
  # Wraps InstantDB Admin SDK in a simple HTTP server.
  # Python scripts call this instead of using unofficial Python clients.
  #
  # Why a separate server?
  # - InstantDB's TypeScript SDK is official + well-maintained
  # - Python InstantDB clients are unofficial and unreliable
  # - HTTP interface is language-agnostic and easy to debug
  # - Centralizes all InstantDB logic in one place
  #
  # Endpoints:
  # - GET  /health                    Health check
  # - POST /videos                    Create/update video
  # - GET  /videos/:id                Get video with runs/segments
  # - PUT  /videos/:id                Update video metadata
  # - POST /ingestion-runs            Save video + runs with metrics
  # - GET  /diarization-segments      Get segments with filters
  # - POST /diarization-segments      Save segments (batch)
  # - POST /words                     Save words (batch)
  # - POST /speaker-assignments       Create speaker assignments
  # - GET  /speakers                  List all speakers
  # - POST /speakers                  Get or create speaker
  # - DELETE /speakers/:id            Delete a speaker
  # ===========================================================================
  instant-proxy:
    build:
      context: ../..
      dockerfile: apps/speaker-diarization-benchmark/Dockerfile.instant-proxy
    container_name: instant-proxy
    restart: unless-stopped
    ports:
      - "3001:3001"
    # Environment variables - use --env-file flag when running docker compose
    # Example: docker compose --env-file ../../.env up -d
    # Or set them directly via environment block below
    environment:
      INSTANT_APP_ID: ${INSTANT_APP_ID}
      INSTANT_ADMIN_SECRET: ${INSTANT_ADMIN_SECRET}
      PORT: "3001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy

  # ===========================================================================
  # GROUND TRUTH SERVER (Python)
  # ===========================================================================
  # Serves the Ground Truth UI for segment labeling.
  # Handles split/relabel/delete operations with InstantDB + PostgreSQL.
  #
  # Why a separate server?
  # - Serves static HTML/JS/CSS for the labeling UI
  # - Handles audio file serving with HTTP Range requests
  # - Coordinates updates between InstantDB and PostgreSQL
  # - Extracts embeddings when assigning speakers to segments
  #
  # Endpoints:
  # - GET  /                          Static file server (UI, audio)
  # - POST /split_segment             Split segment into multiple
  # - POST /assign_speaker            Assign speaker to segment
  # - POST /delete_segment            Delete segment and embedding
  # ===========================================================================
  ground-truth-server:
    build:
      context: .
      dockerfile: Dockerfile.ground-truth-server
    container_name: ground-truth-server
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      INSTANT_APP_ID: ${INSTANT_APP_ID}
      INSTANT_ADMIN_SECRET: ${INSTANT_ADMIN_SECRET}
      POSTGRES_DSN: postgresql://diarization:diarization_dev@postgres:5432/speaker_embeddings
      HF_TOKEN: ${HF_TOKEN:-}
      PORT: "8000"
      # Disable Python output buffering for real-time logs
      PYTHONUNBUFFERED: "1"
    volumes:
      # Mount audio files directory
      - ./data/clips:/app/data/clips:ro
      # Mount code directories for hot reloading during development
      # Changes to Python code are picked up immediately without rebuilding
      - ./ingestion:/app/ingestion:ro
      - ./src:/app/src:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      instant-proxy:
        condition: service_healthy

volumes:
  pgdata:
    name: speaker-diarization-pgdata
