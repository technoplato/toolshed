"""
HOW:
  Import these models to type-check data in the analysis pipeline.
  `from src.data.models import Video, TranscriptionRun, Word, DiarizationSegment`
  
  [Inputs]
  - None (Pydantic definitions)

  [Outputs]
  - Pydantic models for validation.

WHO:
  Antigravity, User
  (Context: Schema redesign for audio ingestion pipeline)

WHAT:
  Defines the core domain entities for the Video Analysis Pipeline.
  
  Entities (New Schema - Dec 2025):
  - Publication: Source platforms (YouTube channels, podcasts, etc.)
  - Video: Ingested media with yt-dlp metadata
  - Speaker: Global speaker identities with embedding centroids
  - TranscriptionConfig: Reusable transcription configurations
  - DiarizationConfig: Reusable diarization configurations
  - TranscriptionRun: Individual transcription executions
  - DiarizationRun: Individual diarization executions
  - Word: First-class word entities with timing
  - DiarizationSegment: Speaker turns with business logic
  - SpeakerAssignment: Links segments to speakers (history preserved)
  - SegmentSplit: Records segment split actions
  - WordTextCorrection: Word text correction history
  - ShazamMatch: Music detection results

WHEN:
  Created: 2025-12-05
  Last Modified: 2025-12-07
  [Change Log:
    - 2025-12-07: Complete redesign to match new InstantDB schema.
                  Removed StableSegment, CorrectedSegment, TranscriptionSegment.
                  Added Publication, Word, SpeakerAssignment, SegmentSplit, WordTextCorrection.
  ]

WHERE:
  apps/speaker-diarization-benchmark/src/data/models.py

WHY:
  To provide a single source of truth for data structures, ensuring consistency 
  between Python code and the InstantDB schema.
"""

from typing import List, Optional, Dict, Any
from pydantic import BaseModel, Field
from datetime import datetime


# =============================================================================
# Base Models
# =============================================================================

class BaseEntity(BaseModel):
    """
    Base class for all entities.
    id is optional on creation (generated by DB/Repo if missing).
    """
    id: Optional[str] = None


# =============================================================================
# Publication
# =============================================================================

class Publication(BaseEntity):
    """
    A source of media content (YouTube channel, podcast, X account, etc.)
    """
    name: str
    publication_type: str
    url: str
    external_id: Optional[str] = None
    raw_metadata: Optional[Dict[str, Any]] = None
    ingested_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Video
# =============================================================================

class Video(BaseEntity):
    """
    Represents a media file ingested into the system.
    Metadata acquired from yt-dlp upon ingestion.
    """
    title: str
    url: str
    filepath: Optional[str] = None
    duration: float
    description: Optional[str] = None
    external_published_at: Optional[str] = None
    raw_metadata: Optional[Dict[str, Any]] = None
    ingested_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Speaker
# =============================================================================

class Speaker(BaseEntity):
    """
    A real-world person or entity that speaks in media.
    Speakers are global and can appear across multiple videos/publications.
    """
    name: str
    is_human: bool = True
    embedding_centroid_id: Optional[str] = None
    metadata: Optional[Dict[str, Any]] = None
    ingested_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Configuration Models
# =============================================================================

class TranscriptionConfig(BaseEntity):
    """
    Configuration for a transcription run.
    Reusable - multiple runs can reference the same config.
    """
    model: str
    tool: str
    language: Optional[str] = "en"
    word_timestamps: bool = True
    vad_filter: Optional[bool] = None
    beam_size: Optional[int] = None
    temperature: Optional[float] = None
    additional_params: Optional[Dict[str, Any]] = None
    created_at: datetime = Field(default_factory=datetime.now)


class DiarizationConfig(BaseEntity):
    """
    Configuration for a diarization run.
    """
    embedding_model: str
    tool: str
    clustering_method: Optional[str] = None
    cluster_threshold: Optional[float] = None
    identification_threshold: Optional[float] = None
    additional_params: Optional[Dict[str, Any]] = None
    created_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Run Models (Execution Metadata)
# =============================================================================

class TranscriptionRun(BaseEntity):
    """
    A single execution of transcription on a video.
    """
    video_id: str
    config_id: Optional[str] = None
    config: Optional[TranscriptionConfig] = None
    
    tool_version: str
    git_commit_sha: Optional[str] = None
    pipeline_script: Optional[str] = None
    is_preferred: bool = False
    processing_time_seconds: Optional[float] = None
    logs: Optional[Dict[str, Any]] = None
    executed_at: datetime = Field(default_factory=datetime.now)


class DiarizationRun(BaseEntity):
    """
    A single execution of speaker diarization on a video.
    Independent of transcription - combined at query time.
    """
    video_id: str
    config_id: Optional[str] = None
    config: Optional[DiarizationConfig] = None
    
    workflow: str
    tool_version: Optional[str] = None
    git_commit_sha: Optional[str] = None
    pipeline_script: Optional[str] = None
    is_preferred: bool = False
    processing_time_seconds: Optional[float] = None
    num_speakers_detected: Optional[int] = None
    logs: Optional[Dict[str, Any]] = None
    executed_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Word (First-class transcription output)
# =============================================================================

class Word(BaseEntity):
    """
    A single word from a transcription with precise timing.
    Words are the atomic unit of transcription output.
    
    At display time, words are grouped into visual segments and
    correlated with diarization segments via time-range queries.
    """
    text: str
    start_time: float
    end_time: float
    confidence: Optional[float] = None
    transcription_segment_index: Optional[int] = None
    ingested_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Diarization Segment
# =============================================================================

class DiarizationSegment(BaseEntity):
    """
    A contiguous time range where a single speaker is talking.
    
    speaker_label is the raw output from the model (e.g., "SPEAKER_0").
    Labels are LOCAL to the diarization run.
    Actual speaker identity is determined via SpeakerAssignment.
    """
    start_time: float
    end_time: float
    speaker_label: str
    embedding_id: Optional[str] = None
    confidence: Optional[float] = None
    is_invalidated: Optional[bool] = False
    created_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Speaker Assignment (History Preserved)
# =============================================================================

class SpeakerAssignment(BaseEntity):
    """
    Links a diarization segment to an identified speaker.
    Multiple assignments can exist (history preserved).
    Most recent assignment is the "current" one.
    
    source: "model" | "user" | "propagated"
    """
    diarization_segment_id: str
    speaker_id: str
    source: str
    confidence: Optional[float] = None
    note: Optional[str] = None
    assigned_by: str
    assigned_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Segment Split
# =============================================================================

class SegmentSplit(BaseEntity):
    """
    Records the action of splitting one diarization segment.
    
    When split:
    1. Original segment marked is_invalidated=true
    2. Two new segments created with createdFromSplit link
    3. Server recomputes embeddings for new segments
    """
    original_segment_id: str
    split_time: float
    split_by: str
    split_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Word Text Correction (History Preserved)
# =============================================================================

class WordTextCorrection(BaseEntity):
    """
    A user correction to a word's transcribed text.
    Multiple corrections can exist (history preserved).
    Most recent correction is the "current" text.
    """
    word_id: str
    corrected_text: str
    note: Optional[str] = None
    corrected_by: str
    corrected_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Shazam Match
# =============================================================================

class ShazamMatch(BaseEntity):
    """
    Music detection result from Shazam or similar service.
    """
    video_id: str
    start_time: float
    end_time: float
    shazam_track_id: str
    title: str
    artist: str
    match_offset: Optional[float] = None
    created_at: datetime = Field(default_factory=datetime.now)


# =============================================================================
# Legacy Models (Deprecated - kept for migration reference)
# =============================================================================

class TranscriptionSegment(BaseModel):
    """
    DEPRECATED: Use Word instead.
    Kept for backward compatibility during migration.
    """
    start: float
    end: float
    text: str
    confidence: Optional[float] = None
    words: Optional[List[Dict[str, Any]]] = None
